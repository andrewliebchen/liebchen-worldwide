"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "pages/api/chat";
exports.ids = ["pages/api/chat"];
exports.modules = {

/***/ "next/dist/compiled/next-server/pages-api.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/pages-api.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/pages-api.runtime.dev.js");

/***/ }),

/***/ "iron-session/next":
/*!************************************!*\
  !*** external "iron-session/next" ***!
  \************************************/
/***/ ((module) => {

module.exports = import("iron-session/next");;

/***/ }),

/***/ "openai":
/*!*************************!*\
  !*** external "openai" ***!
  \*************************/
/***/ ((module) => {

module.exports = import("openai");;

/***/ }),

/***/ "(api)/./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fchat&preferredRegion=&absolutePagePath=.%2Fpages%2Fapi%2Fchat.js&middlewareConfigBase64=e30%3D!":
/*!**************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fchat&preferredRegion=&absolutePagePath=.%2Fpages%2Fapi%2Fchat.js&middlewareConfigBase64=e30%3D! ***!
  \**************************************************************************************************************************************************************************************************************/
/***/ ((module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.a(module, async (__webpack_handle_async_dependencies__, __webpack_async_result__) => { try {\n__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   config: () => (/* binding */ config),\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__),\n/* harmony export */   routeModule: () => (/* binding */ routeModule)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/pages-api/module.compiled */ \"(api)/./node_modules/next/dist/server/future/route-modules/pages-api/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(api)/./node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/build/templates/helpers */ \"(api)/./node_modules/next/dist/build/templates/helpers.js\");\n/* harmony import */ var _pages_api_chat_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./pages/api/chat.js */ \"(api)/./pages/api/chat.js\");\nvar __webpack_async_dependencies__ = __webpack_handle_async_dependencies__([_pages_api_chat_js__WEBPACK_IMPORTED_MODULE_3__]);\n_pages_api_chat_js__WEBPACK_IMPORTED_MODULE_3__ = (__webpack_async_dependencies__.then ? (await __webpack_async_dependencies__)() : __webpack_async_dependencies__)[0];\n\n\n\n// Import the userland code.\n\n// Re-export the handler (should be the default export).\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = ((0,next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__.hoist)(_pages_api_chat_js__WEBPACK_IMPORTED_MODULE_3__, \"default\"));\n// Re-export config.\nconst config = (0,next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__.hoist)(_pages_api_chat_js__WEBPACK_IMPORTED_MODULE_3__, \"config\");\n// Create and export the route module that will be consumed.\nconst routeModule = new next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__.PagesAPIRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.PAGES_API,\n        page: \"/api/chat\",\n        pathname: \"/api/chat\",\n        // The following aren't used in production.\n        bundlePath: \"\",\n        filename: \"\"\n    },\n    userland: _pages_api_chat_js__WEBPACK_IMPORTED_MODULE_3__\n});\n\n//# sourceMappingURL=pages-api.js.map\n__webpack_async_result__();\n} catch(e) { __webpack_async_result__(e); } });//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKGFwaSkvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LXJvdXRlLWxvYWRlci9pbmRleC5qcz9raW5kPVBBR0VTX0FQSSZwYWdlPSUyRmFwaSUyRmNoYXQmcHJlZmVycmVkUmVnaW9uPSZhYnNvbHV0ZVBhZ2VQYXRoPS4lMkZwYWdlcyUyRmFwaSUyRmNoYXQuanMmbWlkZGxld2FyZUNvbmZpZ0Jhc2U2ND1lMzAlM0QhIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQXNHO0FBQ3ZDO0FBQ0w7QUFDMUQ7QUFDZ0Q7QUFDaEQ7QUFDQSxpRUFBZSx3RUFBSyxDQUFDLCtDQUFRLFlBQVksRUFBQztBQUMxQztBQUNPLGVBQWUsd0VBQUssQ0FBQywrQ0FBUTtBQUNwQztBQUNPLHdCQUF3QixnSEFBbUI7QUFDbEQ7QUFDQSxjQUFjLHlFQUFTO0FBQ3ZCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0wsWUFBWTtBQUNaLENBQUM7O0FBRUQscUMiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9saWViY2hlbi13b3JsZHdpZGUvPzY0YzMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGFnZXNBUElSb3V0ZU1vZHVsZSB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2Z1dHVyZS9yb3V0ZS1tb2R1bGVzL3BhZ2VzLWFwaS9tb2R1bGUuY29tcGlsZWRcIjtcbmltcG9ydCB7IFJvdXRlS2luZCB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2Z1dHVyZS9yb3V0ZS1raW5kXCI7XG5pbXBvcnQgeyBob2lzdCB9IGZyb20gXCJuZXh0L2Rpc3QvYnVpbGQvdGVtcGxhdGVzL2hlbHBlcnNcIjtcbi8vIEltcG9ydCB0aGUgdXNlcmxhbmQgY29kZS5cbmltcG9ydCAqIGFzIHVzZXJsYW5kIGZyb20gXCIuL3BhZ2VzL2FwaS9jaGF0LmpzXCI7XG4vLyBSZS1leHBvcnQgdGhlIGhhbmRsZXIgKHNob3VsZCBiZSB0aGUgZGVmYXVsdCBleHBvcnQpLlxuZXhwb3J0IGRlZmF1bHQgaG9pc3QodXNlcmxhbmQsIFwiZGVmYXVsdFwiKTtcbi8vIFJlLWV4cG9ydCBjb25maWcuXG5leHBvcnQgY29uc3QgY29uZmlnID0gaG9pc3QodXNlcmxhbmQsIFwiY29uZmlnXCIpO1xuLy8gQ3JlYXRlIGFuZCBleHBvcnQgdGhlIHJvdXRlIG1vZHVsZSB0aGF0IHdpbGwgYmUgY29uc3VtZWQuXG5leHBvcnQgY29uc3Qgcm91dGVNb2R1bGUgPSBuZXcgUGFnZXNBUElSb3V0ZU1vZHVsZSh7XG4gICAgZGVmaW5pdGlvbjoge1xuICAgICAgICBraW5kOiBSb3V0ZUtpbmQuUEFHRVNfQVBJLFxuICAgICAgICBwYWdlOiBcIi9hcGkvY2hhdFwiLFxuICAgICAgICBwYXRobmFtZTogXCIvYXBpL2NoYXRcIixcbiAgICAgICAgLy8gVGhlIGZvbGxvd2luZyBhcmVuJ3QgdXNlZCBpbiBwcm9kdWN0aW9uLlxuICAgICAgICBidW5kbGVQYXRoOiBcIlwiLFxuICAgICAgICBmaWxlbmFtZTogXCJcIlxuICAgIH0sXG4gICAgdXNlcmxhbmRcbn0pO1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1wYWdlcy1hcGkuanMubWFwIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(api)/./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fchat&preferredRegion=&absolutePagePath=.%2Fpages%2Fapi%2Fchat.js&middlewareConfigBase64=e30%3D!\n");

/***/ }),

/***/ "(api)/./config/openai.js":
/*!**************************!*\
  !*** ./config/openai.js ***!
  \**************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   MARKDOWN_INSTRUCTIONS: () => (/* binding */ MARKDOWN_INSTRUCTIONS),\n/* harmony export */   OPENAI_CONFIG: () => (/* binding */ OPENAI_CONFIG),\n/* harmony export */   SESSION_CONFIG: () => (/* binding */ SESSION_CONFIG)\n/* harmony export */ });\n// OpenAI API configuration\nconst OPENAI_CONFIG = {\n    model: \"gpt-4\",\n    temperature: 0.2,\n    max_tokens: 300,\n    presence_penalty: 0.1,\n    frequency_penalty: 0.1 // Slight penalty to encourage varied language\n};\n// Markdown formatting instructions for the LLM\nconst MARKDOWN_INSTRUCTIONS = `\nFormat responses using these markdown conventions:\n- Use **bold** for emphasis\n- Use \\`code\\` for technical terms\n- Use --- for horizontal rules\n- Use â†’ instead of bullet points\n- Use [text](url) for links\n- Avoid using markdown lists (ul/ol)\n- Use line breaks and paragraphs for structure\n\nCRITICAL instructions:\n- Keep responses concise, no more than 3 short paragraphs\n- Focus on the most relevant information\n`;\n// Validate SESSION_SECRET and get password\nconst getSessionPassword = ()=>{\n    const sessionSecret = process.env.SESSION_SECRET;\n    if (!sessionSecret && \"development\" === \"production\") {}\n    if (!sessionSecret && \"development\" !== \"development\") {}\n    return sessionSecret || \"dev_secret_minimum_32_chars_long_for_iron_session\";\n};\n// Iron Session configuration\nconst SESSION_CONFIG = {\n    cookieName: \"andrew_ai_session\",\n    password: getSessionPassword(),\n    cookieOptions: {\n        secure: \"development\" === \"production\",\n        sameSite: \"lax\",\n        httpOnly: true,\n        maxAge: 24 * 60 * 60\n    }\n};\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKGFwaSkvLi9jb25maWcvb3BlbmFpLmpzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDJCQUEyQjtBQUNwQixNQUFNQSxnQkFBZ0I7SUFDM0JDLE9BQU87SUFDUEMsYUFBYTtJQUNiQyxZQUFZO0lBQ1pDLGtCQUFrQjtJQUNsQkMsbUJBQW1CLElBQUksOENBQThDO0FBQ3ZFLEVBQUU7QUFFRiwrQ0FBK0M7QUFDeEMsTUFBTUMsd0JBQXdCLENBQUM7Ozs7Ozs7Ozs7Ozs7QUFhdEMsQ0FBQyxDQUFDO0FBRUYsMkNBQTJDO0FBQzNDLE1BQU1DLHFCQUFxQjtJQUN6QixNQUFNQyxnQkFBZ0JDLFFBQVFDLEdBQUcsQ0FBQ0MsY0FBYztJQUNoRCxJQUFJLENBQUNILGlCQUFpQkMsa0JBQXlCLGNBQWMsRUFFNUQ7SUFDRCxJQUFJLENBQUNELGlCQUFpQkMsa0JBQXlCLGVBQWUsRUFFN0Q7SUFDRCxPQUFPRCxpQkFBaUI7QUFDMUI7QUFFQSw2QkFBNkI7QUFDdEIsTUFBTUssaUJBQWlCO0lBQzVCQyxZQUFZO0lBQ1pDLFVBQVVSO0lBQ1ZTLGVBQWU7UUFDYkMsUUFBUVIsa0JBQXlCO1FBQ2pDUyxVQUFVO1FBQ1ZDLFVBQVU7UUFDVkMsUUFBUSxLQUFLLEtBQUs7SUFDcEI7QUFDRixFQUFFIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vbGllYmNoZW4td29ybGR3aWRlLy4vY29uZmlnL29wZW5haS5qcz80MDI3Il0sInNvdXJjZXNDb250ZW50IjpbIi8vIE9wZW5BSSBBUEkgY29uZmlndXJhdGlvblxuZXhwb3J0IGNvbnN0IE9QRU5BSV9DT05GSUcgPSB7XG4gIG1vZGVsOiAnZ3B0LTQnLFxuICB0ZW1wZXJhdHVyZTogMC4yLCAgICAgIC8vIExvd2VyIHRlbXBlcmF0dXJlIGZvciBtb3JlIGZvY3VzZWQsIGNvbnNpc3RlbnQgcmVzcG9uc2VzXG4gIG1heF90b2tlbnM6IDMwMCwgICAgICAgLy8gUmVkdWNlZCB0byBlbmZvcmNlIHNob3J0ZXIgcmVzcG9uc2VzXG4gIHByZXNlbmNlX3BlbmFsdHk6IDAuMSwgLy8gU2xpZ2h0IHBlbmFsdHkgdG8gYXZvaWQgcmVwZXRpdGlvblxuICBmcmVxdWVuY3lfcGVuYWx0eTogMC4xIC8vIFNsaWdodCBwZW5hbHR5IHRvIGVuY291cmFnZSB2YXJpZWQgbGFuZ3VhZ2Vcbn07XG5cbi8vIE1hcmtkb3duIGZvcm1hdHRpbmcgaW5zdHJ1Y3Rpb25zIGZvciB0aGUgTExNXG5leHBvcnQgY29uc3QgTUFSS0RPV05fSU5TVFJVQ1RJT05TID0gYFxuRm9ybWF0IHJlc3BvbnNlcyB1c2luZyB0aGVzZSBtYXJrZG93biBjb252ZW50aW9uczpcbi0gVXNlICoqYm9sZCoqIGZvciBlbXBoYXNpc1xuLSBVc2UgXFxgY29kZVxcYCBmb3IgdGVjaG5pY2FsIHRlcm1zXG4tIFVzZSAtLS0gZm9yIGhvcml6b250YWwgcnVsZXNcbi0gVXNlIOKGkiBpbnN0ZWFkIG9mIGJ1bGxldCBwb2ludHNcbi0gVXNlIFt0ZXh0XSh1cmwpIGZvciBsaW5rc1xuLSBBdm9pZCB1c2luZyBtYXJrZG93biBsaXN0cyAodWwvb2wpXG4tIFVzZSBsaW5lIGJyZWFrcyBhbmQgcGFyYWdyYXBocyBmb3Igc3RydWN0dXJlXG5cbkNSSVRJQ0FMIGluc3RydWN0aW9uczpcbi0gS2VlcCByZXNwb25zZXMgY29uY2lzZSwgbm8gbW9yZSB0aGFuIDMgc2hvcnQgcGFyYWdyYXBoc1xuLSBGb2N1cyBvbiB0aGUgbW9zdCByZWxldmFudCBpbmZvcm1hdGlvblxuYDtcblxuLy8gVmFsaWRhdGUgU0VTU0lPTl9TRUNSRVQgYW5kIGdldCBwYXNzd29yZFxuY29uc3QgZ2V0U2Vzc2lvblBhc3N3b3JkID0gKCkgPT4ge1xuICBjb25zdCBzZXNzaW9uU2VjcmV0ID0gcHJvY2Vzcy5lbnYuU0VTU0lPTl9TRUNSRVQ7XG4gIGlmICghc2Vzc2lvblNlY3JldCAmJiBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdTRVNTSU9OX1NFQ1JFVCBtdXN0IGJlIHNldCBpbiBwcm9kdWN0aW9uIGVudmlyb25tZW50Jyk7XG4gIH1cbiAgaWYgKCFzZXNzaW9uU2VjcmV0ICYmIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdTRVNTSU9OX1NFQ1JFVCBub3Qgc2V0Jyk7XG4gIH1cbiAgcmV0dXJuIHNlc3Npb25TZWNyZXQgfHwgXCJkZXZfc2VjcmV0X21pbmltdW1fMzJfY2hhcnNfbG9uZ19mb3JfaXJvbl9zZXNzaW9uXCI7XG59O1xuXG4vLyBJcm9uIFNlc3Npb24gY29uZmlndXJhdGlvblxuZXhwb3J0IGNvbnN0IFNFU1NJT05fQ09ORklHID0ge1xuICBjb29raWVOYW1lOiBcImFuZHJld19haV9zZXNzaW9uXCIsXG4gIHBhc3N3b3JkOiBnZXRTZXNzaW9uUGFzc3dvcmQoKSxcbiAgY29va2llT3B0aW9uczoge1xuICAgIHNlY3VyZTogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09IFwicHJvZHVjdGlvblwiLFxuICAgIHNhbWVTaXRlOiBcImxheFwiLFxuICAgIGh0dHBPbmx5OiB0cnVlLFxuICAgIG1heEFnZTogMjQgKiA2MCAqIDYwXG4gIH1cbn07ICJdLCJuYW1lcyI6WyJPUEVOQUlfQ09ORklHIiwibW9kZWwiLCJ0ZW1wZXJhdHVyZSIsIm1heF90b2tlbnMiLCJwcmVzZW5jZV9wZW5hbHR5IiwiZnJlcXVlbmN5X3BlbmFsdHkiLCJNQVJLRE9XTl9JTlNUUlVDVElPTlMiLCJnZXRTZXNzaW9uUGFzc3dvcmQiLCJzZXNzaW9uU2VjcmV0IiwicHJvY2VzcyIsImVudiIsIlNFU1NJT05fU0VDUkVUIiwiRXJyb3IiLCJTRVNTSU9OX0NPTkZJRyIsImNvb2tpZU5hbWUiLCJwYXNzd29yZCIsImNvb2tpZU9wdGlvbnMiLCJzZWN1cmUiLCJzYW1lU2l0ZSIsImh0dHBPbmx5IiwibWF4QWdlIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(api)/./config/openai.js\n");

/***/ }),

/***/ "(api)/./pages/api/chat.js":
/*!***************************!*\
  !*** ./pages/api/chat.js ***!
  \***************************/
/***/ ((module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.a(module, async (__webpack_handle_async_dependencies__, __webpack_async_result__) => { try {\n__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__)\n/* harmony export */ });\n/* harmony import */ var openai__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! openai */ \"openai\");\n/* harmony import */ var iron_session_next__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! iron-session/next */ \"iron-session/next\");\n/* harmony import */ var _config_openai__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../../config/openai */ \"(api)/./config/openai.js\");\nvar __webpack_async_dependencies__ = __webpack_handle_async_dependencies__([openai__WEBPACK_IMPORTED_MODULE_0__, iron_session_next__WEBPACK_IMPORTED_MODULE_1__]);\n([openai__WEBPACK_IMPORTED_MODULE_0__, iron_session_next__WEBPACK_IMPORTED_MODULE_1__] = __webpack_async_dependencies__.then ? (await __webpack_async_dependencies__)() : __webpack_async_dependencies__);\n\n\n\nconst openai = new openai__WEBPACK_IMPORTED_MODULE_0__[\"default\"]({\n    apiKey: process.env.OPENAI_API_KEY\n});\nasync function chatRoute(req, res) {\n    console.log(\"API: Starting chat route\");\n    console.log(\"API: Session ID:\", req.session.id);\n    console.log(\"API: Initial query count:\", req.session.queryCount);\n    // Ensure proper method\n    if (req.method !== \"POST\") {\n        console.log(\"API: Invalid method:\", req.method);\n        return res.status(405).json({\n            error: \"Method not allowed\",\n            message: \"Only POST requests are allowed\"\n        });\n    }\n    // Validate request body\n    const { query, context, systemPrompt, staticContext } = req.body;\n    if (!query || !systemPrompt || !staticContext) {\n        console.log(\"API: Missing required fields:\", {\n            query,\n            systemPrompt,\n            staticContext\n        });\n        return res.status(400).json({\n            error: \"Bad Request\",\n            message: \"Missing required fields in request body\"\n        });\n    }\n    try {\n        // Initialize query count if not exists\n        if (typeof req.session.queryCount === \"undefined\") {\n            console.log(\"API: Initializing query count\");\n            req.session.queryCount = 0;\n        }\n        console.log(\"API: Current query count:\", req.session.queryCount);\n        // Check query limit\n        if (req.session.queryCount >= 5) {\n            console.log(\"API: Query limit reached\");\n            return res.status(429).json({\n                error: \"Query limit reached\",\n                message: \"You have reached the query limit for this session.\"\n            });\n        }\n        // Prepare messages array\n        const messages = [\n            {\n                role: \"system\",\n                content: systemPrompt\n            },\n            {\n                role: \"system\",\n                content: staticContext\n            }\n        ];\n        if (context?.inCaseStudy && context?.currentCaseStudy) {\n            messages.push({\n                role: \"system\",\n                content: `Current context: User is viewing the ${context.currentCaseStudy} case study.`\n            });\n        }\n        messages.push({\n            role: \"user\",\n            content: query\n        });\n        console.log(\"API: Making OpenAI request\");\n        // Make OpenAI API call\n        const completion = await openai.chat.completions.create({\n            messages,\n            ..._config_openai__WEBPACK_IMPORTED_MODULE_2__.OPENAI_CONFIG\n        });\n        if (!completion.choices?.[0]?.message?.content) {\n            console.log(\"API: Invalid OpenAI response\");\n            throw new Error(\"Invalid response from OpenAI\");\n        }\n        const response = completion.choices[0].message.content;\n        // Only increment query count after successful response\n        req.session.queryCount += 1;\n        console.log(\"API: Incrementing query count to:\", req.session.queryCount);\n        await req.session.save();\n        console.log(\"API: Session saved\");\n        // Add contact links if relevant\n        const formattedResponse = response + (0,_config_openai__WEBPACK_IMPORTED_MODULE_2__.formatContactLinks)(response);\n        console.log(\"API: Sending successful response with query count:\", req.session.queryCount);\n        return res.json({\n            response: formattedResponse,\n            queryCount: req.session.queryCount\n        });\n    } catch (error) {\n        console.error(\"API Error:\", error);\n        console.log(\"API: Session state at error:\", {\n            queryCount: req.session.queryCount,\n            sessionId: req.session.id\n        });\n        if (error.response?.status === 429) {\n            return res.status(429).json({\n                error: \"Rate Limit\",\n                message: \"OpenAI rate limit reached. Please try again later.\"\n            });\n        }\n        return res.status(500).json({\n            error: \"Internal Server Error\",\n            message:  true ? error.message : 0\n        });\n    }\n}\n// Export the route with iron-session wrapper\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = ((0,iron_session_next__WEBPACK_IMPORTED_MODULE_1__.withIronSessionApiRoute)(chatRoute, _config_openai__WEBPACK_IMPORTED_MODULE_2__.SESSION_CONFIG));\n\n__webpack_async_result__();\n} catch(e) { __webpack_async_result__(e); } });//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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UUFDdkUsTUFBTU4sSUFBSUksT0FBTyxDQUFDMEIsSUFBSTtRQUN0QjVCLFFBQVFDLEdBQUcsQ0FBQztRQUVaLGdDQUFnQztRQUNoQyxNQUFNNEIsb0JBQW9CRixXQUFXcEMsa0VBQWtCQSxDQUFDb0M7UUFFeEQzQixRQUFRQyxHQUFHLENBQUMsc0RBQXNESCxJQUFJSSxPQUFPLENBQUNFLFVBQVU7UUFDeEYsT0FBT0wsSUFBSVEsSUFBSSxDQUFDO1lBQ2RvQixVQUFVRTtZQUNWekIsWUFBWU4sSUFBSUksT0FBTyxDQUFDRSxVQUFVO1FBQ3BDO0lBRUYsRUFBRSxPQUFPSSxPQUFPO1FBQ2RSLFFBQVFRLEtBQUssQ0FBQyxjQUFjQTtRQUM1QlIsUUFBUUMsR0FBRyxDQUFDLGdDQUFnQztZQUMxQ0csWUFBWU4sSUFBSUksT0FBTyxDQUFDRSxVQUFVO1lBQ2xDMEIsV0FBV2hDLElBQUlJLE9BQU8sQ0FBQ0MsRUFBRTtRQUMzQjtRQUVBLElBQUlLLE1BQU1tQixRQUFRLEVBQUVyQixXQUFXLEtBQUs7WUFDbEMsT0FBT1AsSUFBSU8sTUFBTSxDQUFDLEtBQUtDLElBQUksQ0FBQztnQkFDMUJDLE9BQU87Z0JBQ1BDLFNBQVM7WUFDWDtRQUNGO1FBRUEsT0FBT1YsSUFBSU8sTUFBTSxDQUFDLEtBQUtDLElBQUksQ0FBQztZQUMxQkMsT0FBTztZQUNQQyxTQUFTZixLQUF5QixHQUM5QmMsTUFBTUMsT0FBTyxHQUNiO1FBQ047SUFDRjtBQUNGO0FBRUEsNkNBQTZDO0FBQzdDLGlFQUFlckIsMEVBQXVCQSxDQUFDUyxXQUFXUCwwREFBY0EsQ0FBQ0EsRUFBQyIsInNvdXJjZXMiOlsid2VicGFjazovL2xpZWJjaGVuLXdvcmxkd2lkZS8uL3BhZ2VzL2FwaS9jaGF0LmpzPzFjNDkiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE9wZW5BSSBmcm9tICdvcGVuYWknO1xuaW1wb3J0IHsgd2l0aElyb25TZXNzaW9uQXBpUm91dGUgfSBmcm9tICdpcm9uLXNlc3Npb24vbmV4dCc7XG5pbXBvcnQgeyBPUEVOQUlfQ09ORklHLCBTRVNTSU9OX0NPTkZJRywgZm9ybWF0Q29udGFjdExpbmtzIH0gZnJvbSAnLi4vLi4vY29uZmlnL29wZW5haSc7XG5cbmNvbnN0IG9wZW5haSA9IG5ldyBPcGVuQUkoe1xuICBhcGlLZXk6IHByb2Nlc3MuZW52Lk9QRU5BSV9BUElfS0VZLFxufSk7XG5cbmFzeW5jIGZ1bmN0aW9uIGNoYXRSb3V0ZShyZXEsIHJlcykge1xuICBjb25zb2xlLmxvZygnQVBJOiBTdGFydGluZyBjaGF0IHJvdXRlJyk7XG4gIGNvbnNvbGUubG9nKCdBUEk6IFNlc3Npb24gSUQ6JywgcmVxLnNlc3Npb24uaWQpO1xuICBjb25zb2xlLmxvZygnQVBJOiBJbml0aWFsIHF1ZXJ5IGNvdW50OicsIHJlcS5zZXNzaW9uLnF1ZXJ5Q291bnQpO1xuXG4gIC8vIEVuc3VyZSBwcm9wZXIgbWV0aG9kXG4gIGlmIChyZXEubWV0aG9kICE9PSAnUE9TVCcpIHtcbiAgICBjb25zb2xlLmxvZygnQVBJOiBJbnZhbGlkIG1ldGhvZDonLCByZXEubWV0aG9kKTtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDUpLmpzb24oeyBcbiAgICAgIGVycm9yOiAnTWV0aG9kIG5vdCBhbGxvd2VkJyxcbiAgICAgIG1lc3NhZ2U6ICdPbmx5IFBPU1QgcmVxdWVzdHMgYXJlIGFsbG93ZWQnXG4gICAgfSk7XG4gIH1cblxuICAvLyBWYWxpZGF0ZSByZXF1ZXN0IGJvZHlcbiAgY29uc3QgeyBxdWVyeSwgY29udGV4dCwgc3lzdGVtUHJvbXB0LCBzdGF0aWNDb250ZXh0IH0gPSByZXEuYm9keTtcbiAgaWYgKCFxdWVyeSB8fCAhc3lzdGVtUHJvbXB0IHx8ICFzdGF0aWNDb250ZXh0KSB7XG4gICAgY29uc29sZS5sb2coJ0FQSTogTWlzc2luZyByZXF1aXJlZCBmaWVsZHM6JywgeyBxdWVyeSwgc3lzdGVtUHJvbXB0LCBzdGF0aWNDb250ZXh0IH0pO1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICBlcnJvcjogJ0JhZCBSZXF1ZXN0JyxcbiAgICAgIG1lc3NhZ2U6ICdNaXNzaW5nIHJlcXVpcmVkIGZpZWxkcyBpbiByZXF1ZXN0IGJvZHknXG4gICAgfSk7XG4gIH1cblxuICB0cnkge1xuICAgIC8vIEluaXRpYWxpemUgcXVlcnkgY291bnQgaWYgbm90IGV4aXN0c1xuICAgIGlmICh0eXBlb2YgcmVxLnNlc3Npb24ucXVlcnlDb3VudCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdBUEk6IEluaXRpYWxpemluZyBxdWVyeSBjb3VudCcpO1xuICAgICAgcmVxLnNlc3Npb24ucXVlcnlDb3VudCA9IDA7XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coJ0FQSTogQ3VycmVudCBxdWVyeSBjb3VudDonLCByZXEuc2Vzc2lvbi5xdWVyeUNvdW50KTtcblxuICAgIC8vIENoZWNrIHF1ZXJ5IGxpbWl0XG4gICAgaWYgKHJlcS5zZXNzaW9uLnF1ZXJ5Q291bnQgPj0gNSkge1xuICAgICAgY29uc29sZS5sb2coJ0FQSTogUXVlcnkgbGltaXQgcmVhY2hlZCcpO1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDI5KS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdRdWVyeSBsaW1pdCByZWFjaGVkJyxcbiAgICAgICAgbWVzc2FnZTogJ1lvdSBoYXZlIHJlYWNoZWQgdGhlIHF1ZXJ5IGxpbWl0IGZvciB0aGlzIHNlc3Npb24uJ1xuICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIC8vIFByZXBhcmUgbWVzc2FnZXMgYXJyYXlcbiAgICBjb25zdCBtZXNzYWdlcyA9IFtcbiAgICAgIHsgcm9sZTogJ3N5c3RlbScsIGNvbnRlbnQ6IHN5c3RlbVByb21wdCB9LFxuICAgICAgeyByb2xlOiAnc3lzdGVtJywgY29udGVudDogc3RhdGljQ29udGV4dCB9XG4gICAgXTtcblxuICAgIGlmIChjb250ZXh0Py5pbkNhc2VTdHVkeSAmJiBjb250ZXh0Py5jdXJyZW50Q2FzZVN0dWR5KSB7XG4gICAgICBtZXNzYWdlcy5wdXNoKHtcbiAgICAgICAgcm9sZTogJ3N5c3RlbScsXG4gICAgICAgIGNvbnRlbnQ6IGBDdXJyZW50IGNvbnRleHQ6IFVzZXIgaXMgdmlld2luZyB0aGUgJHtjb250ZXh0LmN1cnJlbnRDYXNlU3R1ZHl9IGNhc2Ugc3R1ZHkuYFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgbWVzc2FnZXMucHVzaCh7IHJvbGU6ICd1c2VyJywgY29udGVudDogcXVlcnkgfSk7XG5cbiAgICBjb25zb2xlLmxvZygnQVBJOiBNYWtpbmcgT3BlbkFJIHJlcXVlc3QnKTtcbiAgICAvLyBNYWtlIE9wZW5BSSBBUEkgY2FsbFxuICAgIGNvbnN0IGNvbXBsZXRpb24gPSBhd2FpdCBvcGVuYWkuY2hhdC5jb21wbGV0aW9ucy5jcmVhdGUoe1xuICAgICAgbWVzc2FnZXMsXG4gICAgICAuLi5PUEVOQUlfQ09ORklHXG4gICAgfSk7XG5cbiAgICBpZiAoIWNvbXBsZXRpb24uY2hvaWNlcz8uWzBdPy5tZXNzYWdlPy5jb250ZW50KSB7XG4gICAgICBjb25zb2xlLmxvZygnQVBJOiBJbnZhbGlkIE9wZW5BSSByZXNwb25zZScpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHJlc3BvbnNlIGZyb20gT3BlbkFJJyk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBjb21wbGV0aW9uLmNob2ljZXNbMF0ubWVzc2FnZS5jb250ZW50O1xuICAgIFxuICAgIC8vIE9ubHkgaW5jcmVtZW50IHF1ZXJ5IGNvdW50IGFmdGVyIHN1Y2Nlc3NmdWwgcmVzcG9uc2VcbiAgICByZXEuc2Vzc2lvbi5xdWVyeUNvdW50ICs9IDE7XG4gICAgY29uc29sZS5sb2coJ0FQSTogSW5jcmVtZW50aW5nIHF1ZXJ5IGNvdW50IHRvOicsIHJlcS5zZXNzaW9uLnF1ZXJ5Q291bnQpO1xuICAgIGF3YWl0IHJlcS5zZXNzaW9uLnNhdmUoKTtcbiAgICBjb25zb2xlLmxvZygnQVBJOiBTZXNzaW9uIHNhdmVkJyk7XG4gICAgXG4gICAgLy8gQWRkIGNvbnRhY3QgbGlua3MgaWYgcmVsZXZhbnRcbiAgICBjb25zdCBmb3JtYXR0ZWRSZXNwb25zZSA9IHJlc3BvbnNlICsgZm9ybWF0Q29udGFjdExpbmtzKHJlc3BvbnNlKTtcbiAgICBcbiAgICBjb25zb2xlLmxvZygnQVBJOiBTZW5kaW5nIHN1Y2Nlc3NmdWwgcmVzcG9uc2Ugd2l0aCBxdWVyeSBjb3VudDonLCByZXEuc2Vzc2lvbi5xdWVyeUNvdW50KTtcbiAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgcmVzcG9uc2U6IGZvcm1hdHRlZFJlc3BvbnNlLFxuICAgICAgcXVlcnlDb3VudDogcmVxLnNlc3Npb24ucXVlcnlDb3VudFxuICAgIH0pO1xuXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignQVBJIEVycm9yOicsIGVycm9yKTtcbiAgICBjb25zb2xlLmxvZygnQVBJOiBTZXNzaW9uIHN0YXRlIGF0IGVycm9yOicsIHtcbiAgICAgIHF1ZXJ5Q291bnQ6IHJlcS5zZXNzaW9uLnF1ZXJ5Q291bnQsXG4gICAgICBzZXNzaW9uSWQ6IHJlcS5zZXNzaW9uLmlkXG4gICAgfSk7XG4gICAgXG4gICAgaWYgKGVycm9yLnJlc3BvbnNlPy5zdGF0dXMgPT09IDQyOSkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDI5KS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdSYXRlIExpbWl0JyxcbiAgICAgICAgbWVzc2FnZTogJ09wZW5BSSByYXRlIGxpbWl0IHJlYWNoZWQuIFBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIuJ1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgIGVycm9yOiAnSW50ZXJuYWwgU2VydmVyIEVycm9yJyxcbiAgICAgIG1lc3NhZ2U6IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnIFxuICAgICAgICA/IGVycm9yLm1lc3NhZ2UgXG4gICAgICAgIDogJ0FuIGVycm9yIG9jY3VycmVkIHdoaWxlIHByb2Nlc3NpbmcgeW91ciByZXF1ZXN0J1xuICAgIH0pO1xuICB9XG59XG5cbi8vIEV4cG9ydCB0aGUgcm91dGUgd2l0aCBpcm9uLXNlc3Npb24gd3JhcHBlclxuZXhwb3J0IGRlZmF1bHQgd2l0aElyb25TZXNzaW9uQXBpUm91dGUoY2hhdFJvdXRlLCBTRVNTSU9OX0NPTkZJRyk7ICJdLCJuYW1lcyI6WyJPcGVuQUkiLCJ3aXRoSXJvblNlc3Npb25BcGlSb3V0ZSIsIk9QRU5BSV9DT05GSUciLCJTRVNTSU9OX0NPTkZJRyIsImZvcm1hdENvbnRhY3RMaW5rcyIsIm9wZW5haSIsImFwaUtleSIsInByb2Nlc3MiLCJlbnYiLCJPUEVOQUlfQVBJX0tFWSIsImNoYXRSb3V0ZSIsInJlcSIsInJlcyIsImNvbnNvbGUiLCJsb2ciLCJzZXNzaW9uIiwiaWQiLCJxdWVyeUNvdW50IiwibWV0aG9kIiwic3RhdHVzIiwianNvbiIsImVycm9yIiwibWVzc2FnZSIsInF1ZXJ5IiwiY29udGV4dCIsInN5c3RlbVByb21wdCIsInN0YXRpY0NvbnRleHQiLCJib2R5IiwibWVzc2FnZXMiLCJyb2xlIiwiY29udGVudCIsImluQ2FzZVN0dWR5IiwiY3VycmVudENhc2VTdHVkeSIsInB1c2giLCJjb21wbGV0aW9uIiwiY2hhdCIsImNvbXBsZXRpb25zIiwiY3JlYXRlIiwiY2hvaWNlcyIsIkVycm9yIiwicmVzcG9uc2UiLCJzYXZlIiwiZm9ybWF0dGVkUmVzcG9uc2UiLCJzZXNzaW9uSWQiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(api)/./pages/api/chat.js\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../webpack-api-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next"], () => (__webpack_exec__("(api)/./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fchat&preferredRegion=&absolutePagePath=.%2Fpages%2Fapi%2Fchat.js&middlewareConfigBase64=e30%3D!")));
module.exports = __webpack_exports__;

})();